import { Constants } from '../common/constants/Constants';
import router from '@ohos.router';
import prompt from '@ohos.prompt';
import picker from '@ohos.file.picker';

@Entry
@Component
struct Dynamic {
  @State posts: Array<Post> = [];
  @State newPostContent: string = '';
  @State showCommentInput: boolean = false;
  @State currentPostId: number = -1;
  @State commentContent: string = '';
  @State favoritePosts: Set<number> = new Set();
  @State selectedImages: string[] = [];

  @Builder
  PostBuilder(post: Post) {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å’Œå‘å¸ƒæ—¶é—´
      Row() {
        // ç”¨æˆ·å¤´åƒ
        Image(post.avatarUrl || $r('app.media.icon'))
          .width(40)
          .height(40)
          .borderRadius(20)
          .margin({ right: 10 })
        
        Column() {
          // ç”¨æˆ·å
          Text(post.username)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
          
          // å‘å¸ƒæ—¶é—´
          Text(post.createTime)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // åŠ¨æ€å†…å®¹
      Text(post.content)
        .fontSize(16)
        .width('100%')
        .margin({ bottom: 10 })

      // å›¾ç‰‡å±•ç¤º
      if (post.images && post.images.length > 0) {
        Grid() {
          ForEach(post.images, (image: string) => {
            GridItem() {
              Image(image)
                .width('100%')
                .height('100%')
                .objectFit(ImageFit.Cover)
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr')
        .rowsTemplate('1fr 1fr 1fr')
        .columnsGap(5)
        .rowsGap(5)
        .width('100%')
        .height(300)
        .margin({ bottom: 10 })
      }

      // æ“ä½œæ 
      Row() {
        // ç‚¹èµžæŒ‰é’®
        Row() {
          Text(post.isLiked ? 'â™¥' : 'â™¡')
            .fontSize(20)
            .fontColor(post.isLiked ? '#FF0000' : '#666666')
          Text(post.likes.toString())
            .fontSize(14)
            .margin({ left: 5 })
        }
        .onClick(() => {
          post.isLiked = !post.isLiked;
          post.likes += post.isLiked ? 1 : -1;
        })
        .margin({ right: 20 })

        // è¯„è®ºæŒ‰é’®
        Row() {
          Text('ðŸ’¬')
            .fontSize(20)
          Text(post.comments.length.toString())
            .fontSize(14)
            .margin({ left: 5 })
        }
        .onClick(() => {
          this.currentPostId = post.id;
          this.showCommentInput = true;
        })
        .margin({ right: 20 })

        // æ”¶è—æŒ‰é’®
        Row() {
          Text(this.favoritePosts.has(post.id) ? 'â˜…' : 'â˜†')
            .fontSize(20)
            .fontColor(this.favoritePosts.has(post.id) ? '#FFD700' : '#666666')
        }
        .onClick(() => {
          if (this.favoritePosts.has(post.id)) {
            this.favoritePosts.delete(post.id);
            prompt.showToast({ message: 'å·²å–æ¶ˆæ”¶è—' });
          } else {
            this.favoritePosts.add(post.id);
            prompt.showToast({ message: 'å·²æ”¶è—' });
          }
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // è¯„è®ºåˆ—è¡¨
      if (post.comments.length > 0) {
        Column() {
          ForEach(post.comments, (comment: Comment) => {
            Row() {
              Text(comment.username)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1698CE')
              Text(comment.content)
                .fontSize(14)
                .margin({ left: 5 })
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 5 })
          })
        }
        .width('100%')
        .padding(10)
        .backgroundColor('#F5F5F5')
        .borderRadius(5)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .margin({ bottom: 10 })
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })
        
        Text('å‘è¡¨åŠ¨æ€')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // å‘å¸ƒåŠ¨æ€åŒºåŸŸ
      Column() {
        // æ–‡æœ¬è¾“å…¥æ¡†
        TextArea({ placeholder: 'åˆ†äº«ä½ çš„æƒ³æ³•...', text: this.newPostContent })
          .width('100%')
          .height(120)
          .backgroundColor('#F5F5F5')
          .borderRadius(8)
          .padding(12)
          .margin({ bottom: 16 })
          .onChange((value: string) => {
            this.newPostContent = value;
          })

        // å›¾ç‰‡é€‰æ‹©åŒºåŸŸ
        Row() {
          Button('é€‰æ‹©å›¾ç‰‡', { type: ButtonType.Normal })
            .width(120)
            .height(40)
            .backgroundColor('#1698CE')
            .fontColor('#FFFFFF')
            .borderRadius(20)
            .onClick(() => {
              this.selectImages();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .margin({ bottom: 16 })

        // å·²é€‰å›¾ç‰‡é¢„è§ˆ
        if (this.selectedImages.length > 0) {
          Grid() {
            ForEach(this.selectedImages, (image: string) => {
              GridItem() {
                Image(image)
                  .width('100%')
                  .height('100%')
                  .objectFit(ImageFit.Cover)
                  .borderRadius(8)
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .rowsTemplate('1fr')
          .columnsGap(8)
          .rowsGap(8)
          .width('100%')
          .height(200)
          .margin({ bottom: 16 })
        }

        // å‘å¸ƒæŒ‰é’®
        Button('å‘å¸ƒ', { type: ButtonType.Normal })
          .width('100%')
          .height(40)
          .backgroundColor('#1698CE')
          .fontColor('#FFFFFF')
          .borderRadius(20)
          .onClick(() => {
            if (this.newPostContent.trim()) {
              this.posts.unshift({
                id: this.posts.length + 1,
                username: 'å½“å‰ç”¨æˆ·',
                avatarUrl: '',
                content: this.newPostContent,
                createTime: new Date().toLocaleString(),
                likes: 0,
                isLiked: false,
                images: this.selectedImages,
                comments: []
              });
              this.newPostContent = '';
              this.selectedImages = [];
              prompt.showToast({ message: 'å‘å¸ƒæˆåŠŸ' });
              router.back();
            } else {
              prompt.showToast({ message: 'è¯·è¾“å…¥åŠ¨æ€å†…å®¹' });
            }
          })
      }
      .width('100%')
      .padding(16)
      .backgroundColor('#FFFFFF')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
  }

  private selectImages(): void {
    let photoPicker = new picker.PhotoViewPicker();
    photoPicker.select()
      .then((result: picker.PhotoSelectResult) => {
        if (result && result.photoUris && result.photoUris.length > 0) {
          this.selectedImages = result.photoUris;
        }
      })
      .catch((err: Error) => {
        console.error(`é€‰æ‹©å›¾ç‰‡å¤±è´¥: ${err.message}`);
      });
  }
}

interface Post {
  id: number;
  username: string;
  avatarUrl: string;
  content: string;
  createTime: string;
  likes: number;
  isLiked: boolean;
  images: string[];
  comments: Array<Comment>;
}

interface Comment {
  username: string;
  content: string;
} 