import { Constants } from '../common/constants/Constants';
import router from '@ohos.router';
import { CategoryItem } from '../common/constants/Constants';
import { Artifact } from '../model/ArtifactModel';
import { ArtifactService } from '../services/ArtifactService';
import prompt from '@ohos.prompt';
import picker from '@ohos.file.picker';
import { UserService } from '../services/UserService';
import { UserInfo } from '../services/UserService';

/**
 * Âä®ÊÄÅÂ∏ñÂ≠êÊé•Âè£
 */
interface Post {
  id: number;
  username: string;
  avatarUrl: string;
  content: string;
  createTime: string;
  likes: number;
  isLiked: boolean;
  images: Resource[];
  comments: Array<Comment>;
}

/**
 * ËØÑËÆ∫Êé•Âè£
 */
interface Comment {
  username: string;
  content: string;
}

/**
 * SheetÈ°πÁõÆÊé•Âè£
 */
interface Sheet {
  title: string;
  action: () => void;
}

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State searchKeyword: string = '';
  @State searchResults: Artifact[] = [];
  @State isLoading: boolean = false;
  @State posts: Array<Post> = [];
  @State favoritePosts: Set<number> = new Set();
  @State selectedImages: Resource[] = [];
  @State newPostContent: string = '';
  @State artifacts: Artifact[] = [];
  @State isArtifactsLoading: boolean = false;
  @State selectedCategory: CategoryItem = { id: 0, name: 'ÂÖ®ÈÉ®' };
  @State userInfo: UserInfo | null = null;
  
  private artifactService: ArtifactService = new ArtifactService();
  private userService: UserService = new UserService();

  build() {
    Column() {
      // ‰∏ª‰ΩìÂÜÖÂÆπÂå∫Âüü
      Tabs({
        barPosition: BarPosition.End,
        controller: new TabsController()
      }) {
        // È¶ñÈ°µTab
        TabContent() {
          this.buildHomePage()
        }
        .tabBar(this.TabBuilder(0, 'È¶ñÈ°µ', 'home'))
        
        // ÊñáÁâ©Â±ïÁ§∫Tab
        TabContent() {
          this.buildArtifactsPage()
        }
        .tabBar(this.TabBuilder(1, 'ÊñáÁâ©', 'list'))
        
        // ÊêúÁ¥¢Tab
        TabContent() {
          this.buildSearchPage()
        }
        .tabBar(this.TabBuilder(2, 'ÊêúÁ¥¢', 'search'))
        
        // Âä®ÊÄÅTab
        TabContent() {
          this.buildDynamicPage()
        }
        .tabBar(this.TabBuilder(3, 'Âä®ÊÄÅ', 'icon'))
        
        // ÊàëÁöÑTab
        TabContent() {
          this.buildProfilePage()
        }
        .tabBar(this.TabBuilder(4, 'ÊàëÁöÑ', 'person'))
      }
      .width('100%')
      .height('100%')
      .barHeight(56)
      .onChange((index) => {
        this.currentIndex = index
      })
    }
    .width('100%')
    .height('100%')
  }
  
  @Builder
  TabBuilder(index: number, title: string, icon: string) {
    Column() {
      Image($r(`app.media.${icon}`))
        .width(24)
        .height(24)
        .fillColor(this.currentIndex === index ? '#1698CE' : '#666666')
      Text(title)
        .fontSize(12)
        .fontColor(this.currentIndex === index ? '#1698CE' : '#666666')
        .margin({ top: 4 })
    }
    .width(56)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
  
  @Builder
  buildHomePage() {
    Scroll() {
      Column() {
        Text('Êéå‰∏äÂçöÁâ©È¶Ü')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 20 })
        
        // ËΩÆÊí≠Âõæ
        Swiper() {
          // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑËΩÆÊí≠ÂõæÂÜÖÂÆπ
          Text('ËΩÆÊí≠Âõæ1').width('100%').height(200).backgroundColor('#66CCFF')
          Text('ËΩÆÊí≠Âõæ2').width('100%').height(200).backgroundColor('#6699FF')
          Text('ËΩÆÊí≠Âõæ3').width('100%').height(200).backgroundColor('#66CCCC')
        }
        .autoPlay(true)
        .interval(3000)
        .width('90%')
        .height(200)
        .borderRadius(10)
        .margin({ bottom: 20 })
        
        // ÂàÜÁ±ªÂå∫Âüü
        Text('ÊñáÁâ©ÂàÜÁ±ª').fontSize(20).fontWeight(FontWeight.Bold).alignSelf(ItemAlign.Start).margin({ left: 16, top: 10, bottom: 10 })
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceAround }) {
          ForEach(Constants.ARTIFACT_CATEGORIES, (category: CategoryItem) => {
            Column() {
              // ËøôÈáåÂ∫îÂä†ÂÖ•ÂÆûÈôÖÁöÑÂõæÊ†á
              Image($r('app.media.icon'))
                .width(50)
                .height(50)
                .margin({ bottom: 5 })
              Text(category.name)
                .fontSize(14)
            }
            .width('30%')
            .aspectRatio(1)
            .margin(5)
            .borderRadius(8)
            .backgroundColor('#F5F5F5')
            .justifyContent(FlexAlign.Center)
          })
        }
        .padding(10)
        
        // Êé®ËçêÊñáÁâ©
        Text('Êé®ËçêÊñáÁâ©').fontSize(20).fontWeight(FontWeight.Bold).alignSelf(ItemAlign.Start).margin({ left: 16, top: 16, bottom: 10 })
        List({ space: 10 }) {
          // ËøôÈáåÂ∫îÂä†ÂÖ•ÂÆûÈôÖÁöÑÊñáÁâ©Êï∞ÊçÆ
          ListItem() {
            Row() {
              Image($r('app.media.icon'))
                .width(80)
                .height(80)
                .borderRadius(5)
              Column() {
                Text('ÈùíËä±Áì∑Áì∂').fontSize(16).fontWeight(FontWeight.Bold)
                Text('ÊòéÊúù').fontSize(14).margin({ top: 5 })
                Text('Â§ßËã±ÂçöÁâ©È¶Ü').fontSize(14).margin({ top: 5 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
              .layoutWeight(1)
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
          
          ListItem() {
            Row() {
              Image($r('app.media.icon'))
                .width(80)
                .height(80)
                .borderRadius(5)
              Column() {
                Text('ÁéâÂô®ÊëÜ‰ª∂').fontSize(16).fontWeight(FontWeight.Bold)
                Text('Ê∏ÖÊúù').fontSize(14).margin({ top: 5 })
                Text('Â§ßÈÉΩ‰ºöÂçöÁâ©È¶Ü').fontSize(14).margin({ top: 5 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
              .layoutWeight(1)
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
        }
        .width('90%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F0F0F0')
      .padding({ bottom: 56 })
    }
    .scrollBar(BarState.Off)
    .width('100%')
    .height('100%')
  }
  
  @Builder
  buildArtifactsPage() {
    Column() {
      Text('ÊñáÁâ©Â±ïÁ§∫').fontSize(24).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 20 })
      
      // Ê∑ªÂä†ÂàÜÁ±ªÈÄâÊã©Âô®
      Row() {
        Text('ÂàÜÁ±ªÔºö').fontSize(16).fontColor('#666666')
        
        Row() {
          Text(this.selectedCategory.name)
            .fontSize(16)
            .fontColor('#1698CE')
            .layoutWeight(1)
          
          Image($r('app.media.arrow_right'))
            .width(20)
            .height(20)
            .fillColor('#1698CE')
            .margin({ left: 5 })
        }
        .width('80%')
        .height(40)
        .borderRadius(20)
        .backgroundColor('#F5F5F5')
        .padding({ left: 15, right: 15 })
        .justifyContent(FlexAlign.SpaceBetween)
        .onClick(() => {
          ActionSheet.show({
            title: 'ÈÄâÊã©ÂàÜÁ±ª',
            message: 'ËØ∑ÈÄâÊã©ÊÇ®ÊÉ≥Ë¶ÅÊü•ÁúãÁöÑÊñáÁâ©ÂàÜÁ±ª',
            sheets: Constants.ARTIFACT_CATEGORIES.map((item): Sheet => ({
              title: item.name,
              action: () => {
                this.selectedCategory = item;
                this.loadArtifacts();
              }
            }))
          });
        })
      }
      .width('90%')
      .margin({ bottom: 20 })
      
      // Âä†ËΩΩÁä∂ÊÄÅ
      if (this.isArtifactsLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1698CE')
          
          Text('Ê≠£Âú®Âä†ËΩΩÊñáÁâ©Êï∞ÊçÆ...')
            .fontSize(16)
            .margin({ top: 10 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } 
      // ÊñáÁâ©ÂàóË°®
      else if (this.artifacts.length > 0) {
        Grid() {
          ForEach(this.artifacts, (artifact: Artifact) => {
            GridItem() {
              Column() {
                // ÊñáÁâ©ÂõæÁâá
                Stack() {
                  Image(artifact.imageUrl || $r('app.media.placeholder'))
                    .width('100%')
                    .height(180)
                    .objectFit(ImageFit.Cover)
                    .borderRadius({ topLeft: 8, topRight: 8 })

                }
                .width('100%')
                
                // ÊñáÁâ©‰ø°ÊÅØ
                Column() {
                  Text(artifact.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Row() {
                    Text(`${artifact.era}`)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ right: 8 })
                    Text(artifact.museum)
                      .fontSize(14)
                      .fontColor('#666666')
                      .backgroundColor('#00000010')
                      .borderRadius(10)
                      .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                      .margin({ right: 8 })
                  }
                  .width('100%')
                  .margin({ top: 5 })
                }
                .width('100%')
                .padding(10)
              }
              .width('100%')
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                router.pushUrl({
                  url: 'pages/ArtifactDetail',
                  params: { artifactId: artifact.id }
                });
              })
            }
            .aspectRatio(0.75)  // ÂÆΩÈ´òÊØî
          })
        }
        .columnsTemplate('1fr 1fr')  // ‰∏§ÂàóÂ∏ÉÂ±Ä
        .columnsGap(12)  // ÂàóÈó¥Ë∑ùÔºàÂèØÈÄÇÂΩìÂä†Â§ßÔºâ
        .rowsGap(12)  // Ë°åÈó¥Ë∑ùÔºàÂèØÈÄÇÂΩìÂä†Â§ßÔºâ
        .width('100%')  // ËøôÈáåÊîπÊàê100%
        .layoutWeight(1)
      } 
      // Êó†Êï∞ÊçÆÁä∂ÊÄÅ
      else {
        Column() {
          Image($r('app.media.no_result'))
            .width(100)
            .height(100)
            .margin({ bottom: 20 })
          
          Text('ÊöÇÊó†ÊñáÁâ©Êï∞ÊçÆ')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
    .padding({ bottom: 56 })
  }
  
  @Builder
  buildSearchPage() {
    Stack() {
      // ËÉåÊôØÂõæÁâá
      Image($r('app.media.background2'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .opacity(0.1)

      Column() {
        Text('ÊñáÁâ©ÊêúÁ¥¢')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
          .margin({ top: 20, bottom: 20 })
        
        // ÊêúÁ¥¢Ê°Ü
        Row() {
          TextInput({ placeholder: 'ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢ÊñáÁâ©' })
            .width('80%')
            .height(40)
            .backgroundColor('#FFFFFF')
            .borderRadius(20)
            .padding({ left: 15, right: 15 })
            .borderColor('#8B0000')
            .borderWidth(1)
            .onChange((value: string) => {
              this.searchKeyword = value;
            })
          
          Image($r('app.media.search'))
            .width(24)
            .height(24)
            .margin({ left: 10 })
            .fillColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
            .onClick(() => {
              this.performSearch();
            })
        }
        .width('90%')
        .margin({ bottom: 20 })
        
        Divider()
          .width('90%')
          .color('#8B0000')  // Ê∑±Á∫¢Ëâ≤
          .margin({ top: 5, bottom: 5 })
        
        // ÂõæÂÉèÊêúÁ¥¢ÊåâÈíÆ
        Button('ÊãçÁÖßÊêúÁ¥¢ÊñáÁâ©', { type: ButtonType.Normal })
          .width('80%')
          .height(50)
          .backgroundColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
          .fontColor('#FFFFFF')
          .borderRadius(25)
          .margin({ top: 20 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/ImageSearch'
            });
          })
        
        // ÊêúÁ¥¢ÁªìÊûúÂå∫Âüü
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(50)
              .height(50)
              .color('#8B0000')  // Ê∑±Á∫¢Ëâ≤
              .margin({ bottom: 20 })
            
            Text('Ê≠£Âú®ÊêúÁ¥¢‰∏≠...')
              .fontSize(18)
              .fontColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
              .margin({ bottom: 10 })
            
            Text('ËØ∑Á®çÂÄôÔºåÊàë‰ª¨Ê≠£Âú®‰∏∫ÊÇ®Êü•ÊâæÁõ∏ÂÖ≥ÊñáÁâ©')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(15)
          .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
          .margin({ top: 20 })
        } else if (this.searchResults.length > 0) {
          Text('ÊêúÁ¥¢ÁªìÊûú')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
            .alignSelf(ItemAlign.Start)
            .margin({ left: '5%', top: 20, bottom: 10 })
          
          List({ space: 10 }) {
            ForEach(this.searchResults, (artifact: Artifact) => {
              ListItem() {
                Row() {
                  Image(artifact.imageUrl || $r('app.media.placeholder'))
                    .width(100)
                    .height(100)
                    .borderRadius(10)
                    .objectFit(ImageFit.Cover)
                    .border({ width: 1, color: '#8B0000' })  // Ê∑±Á∫¢Ëâ≤ËæπÊ°Ü
                  
                  Column() {
                    Text(artifact.name)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
                    
                    Text(artifact.era)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 5 })
                    
                    Text(artifact.museum)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 5 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .margin({ left: 15 })
                  .layoutWeight(1)
                }
                .width('100%')
                .padding(15)
                .backgroundColor('#FFFFFF')
                .borderRadius(15)
                .border({ width: 1, color: '#8B0000' })  // Ê∑±Á∫¢Ëâ≤ËæπÊ°Ü
                .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ArtifactDetail',
                    params: { artifactId: artifact.id }
                  });
                })
              }
            })
          }
          .width('90%')
          .layoutWeight(1)
        } else if (this.searchKeyword) {
          Column() {
            Image($r('app.media.no_result'))
              .width(100)
              .height(100)
              .margin({ bottom: 16 })
              .fillColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
              
            Text('Êä±Ê≠âÔºåÊú™ÊâæÂà∞Áõ∏ÂÖ≥ÊñáÁâ©')
              .fontSize(18)
              .fontColor('#8B0000')  // Ê∑±Á∫¢Ëâ≤
              .margin({ bottom: 10 })
            
            Text('ËØ∑Â∞ùËØï‰ΩøÁî®ÂÖ∂‰ªñÂÖ≥ÈîÆËØçËøõË°åÊêúÁ¥¢')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(15)
          .border({ width: 1, color: '#8B0000' })  // Ê∑±Á∫¢Ëâ≤ËæπÊ°Ü
          .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
          .margin({ top: 20 })
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF5F5')  // ÊµÖÁ∫¢Ëâ≤ËÉåÊôØ
    .padding({ bottom: 56 })
  }
  
  private performSearch(): void {
    if (!this.searchKeyword.trim()) {
      prompt.showToast({ message: 'ËØ∑ËæìÂÖ•ÊêúÁ¥¢ÂÖ≥ÈîÆËØç' });
      return;
    }
    
    this.isLoading = true;
    this.artifactService.searchByKeyword(this.searchKeyword)
      .then((artifacts: Artifact[]) => {
        this.searchResults = artifacts;
        this.isLoading = false;
      })
      .catch((error: Error) => {
        this.isLoading = false;
        prompt.showToast({ message: `ÊêúÁ¥¢Â§±Ë¥•: ${error.message}` });
      });
  }
  
  @Builder
  buildProfileItem(title: string, icon: string) {
    Row() {
      Row() {
        // Â∑¶‰æßÂõæÊ†á
        Image($r(`app.media.${icon}`))
          .width(24)
          .height(24)
          .fillColor('#666666')
        
        // Ê†áÈ¢òÊñáÂ≠ó
        Text(title)
          .fontSize(16)
          .fontColor('#333333')
          .margin({ left: 12 })
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Center)
      
      // Âè≥‰æßÁÆ≠Â§¥
      Image($r('app.media.arrow_right'))
        .width(20)
        .height(20)
        .fillColor('#999999')
    }
    .width('100%')
    .padding({ top: 16, bottom: 16, left: 8, right: 8 })
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      if (title === 'ËÆæÁΩÆ') {
        router.pushUrl({
          url: 'pages/Settings'
        });
      } else if (title === 'ÊàëÁöÑÊî∂Ëóè') {
        router.pushUrl({
          url: 'pages/Favorites'
        });
      } else if (title === 'ÊµèËßàÂéÜÂè≤') {
        router.pushUrl({
          url: 'pages/History'
        });
      } else if (title === 'ÊàëÁöÑËØÑËÆ∫') {
        router.pushUrl({
          url: 'pages/Comments'
        });
      }
    })
  }
  
  @Builder
  buildDynamicPage() {
    Column() {
      // È°∂ÈÉ®Ê†è
      Row() {
        Text('Âä®ÊÄÅ')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // ÂèëË°®Âä®ÊÄÅÊåâÈíÆ
        Button('ÂèëË°®', { type: ButtonType.Normal })
          .width(60)
          .height(30)
          .backgroundColor('#1698CE')
          .fontColor('#FFFFFF')
          .borderRadius(15)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Dynamic'
            });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      .backgroundColor('#FFFFFF')
      .borderRadius({ bottomLeft: 10, bottomRight: 10 })
      .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 2 })

      // Âä®ÊÄÅÂàóË°®
      List({ space: 10 }) {
        ForEach(this.posts, (post: Post) => {
          ListItem() {
            this.PostBuilder(post)
          }
        })
      }
      .width('100%')
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF5F5')  // ÊµÖÁ∫¢Ëâ≤ËÉåÊôØ
    .padding({ bottom: 56 })
  }
  
  @Builder
  PostBuilder(post: Post) {
    Column() {
      // Áî®Êà∑‰ø°ÊÅØÂíåÂèëÂ∏ÉÊó∂Èó¥
      Row() {
        // Áî®Êà∑Â§¥ÂÉè
        Image(post.avatarUrl || $r('app.media.icon'))
          .width(40)
          .height(40)
          .borderRadius(20)
          .margin({ right: 10 })
        
        Column() {
          // Áî®Êà∑Âêç
          Text(post.username)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
          
          // ÂèëÂ∏ÉÊó∂Èó¥
          Text(post.createTime)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // Âä®ÊÄÅÂÜÖÂÆπ
      Text(post.content)
        .fontSize(16)
        .width('100%')
        .margin({ bottom: 10 })

      // ÂõæÁâáÂ±ïÁ§∫
      if (post.images && post.images.length > 0) {
        Grid() {
          ForEach(post.images, (image: Resource) => {
            GridItem() {
              Image($r('app.media.cultural_heritage_logo'))
                .width('100%')
                .height('100%')
                .objectFit(ImageFit.Cover)
                .borderRadius(8)
            }
          })
        }
        .columnsTemplate('1fr')
        .rowsTemplate('1fr')
        .columnsGap(5)
        .rowsGap(5)
        .width('100%')
        .height(300)
        .margin({ bottom: 10 })
      }

      // Êìç‰ΩúÊ†è
      Row() {
        // ÁÇπËµûÊåâÈíÆ
        Row() {
          Text(post.isLiked ? '‚ô•' : '‚ô°')
            .fontSize(20)
            .fontColor(post.isLiked ? '#FF0000' : '#666666')
          Text(post.likes.toString())
            .fontSize(14)
            .margin({ left: 5 })
        }
        .onClick(() => {
          post.isLiked = !post.isLiked;
          post.likes += post.isLiked ? 1 : -1;
        })
        .margin({ right: 20 })

        // ËØÑËÆ∫ÊåâÈíÆ
        Row() {
          Text('üí¨')
            .fontSize(20)
          Text(post.comments.length.toString())
            .fontSize(14)
            .margin({ left: 5 })
        }
        .margin({ right: 20 })

        // Êî∂ËóèÊåâÈíÆ
        Row() {
          Text(this.favoritePosts.has(post.id) ? '‚òÖ' : '‚òÜ')
            .fontSize(20)
            .fontColor(this.favoritePosts.has(post.id) ? '#FFD700' : '#666666')
        }
        .onClick(() => {
          if (this.favoritePosts.has(post.id)) {
            this.favoritePosts.delete(post.id);
            prompt.showToast({ message: 'Â∑≤ÂèñÊ∂àÊî∂Ëóè' });
          } else {
            this.favoritePosts.add(post.id);
            prompt.showToast({ message: 'Â∑≤Êî∂Ëóè' });
          }
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // ËØÑËÆ∫ÂàóË°®
      if (post.comments.length > 0) {
        Column() {
          ForEach(post.comments, (comment: Comment) => {
            Row() {
              Column() {
                Row() {
                  Text(comment.username)
                    .fontSize(14)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1698CE')
                  Text(comment.content)
                    .fontSize(14)
                    .margin({ left: 5 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .layoutWeight(1)
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 5 })
          })
        }
        .width('100%')
        .padding(10)
        .backgroundColor('#F5F5F5')
        .borderRadius(5)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .margin({ bottom: 10 })
  }
  
  @Builder
  buildProfilePage() {
    Column() {
      Text('‰∏™‰∫∫‰∏≠ÂøÉ').fontSize(24).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 20 })
      
      Column() {
        // Áî®Êà∑‰ø°ÊÅØÂå∫Âüü
        Row() {
          if (this.userInfo) {
            // ÊòæÁ§∫Áî®Êà∑Â§¥ÂÉè
            Image(this.userInfo.img_url || $r('app.media.icon'))
              .width(80)
              .height(80)
              .borderRadius(40)
              .objectFit(ImageFit.Cover)
            
            Column() {
              Text(this.userInfo.nickname || 'Êú™ËÆæÁΩÆÊòµÁß∞')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
              Text(this.userInfo.phone || 'Êú™ÁªëÂÆöÊâãÊú∫Âè∑')
                .fontSize(14)
                .margin({ top: 5 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 20 })
          } else {
            // Êú™ÁôªÂΩïÁä∂ÊÄÅ
            Image($r('app.media.icon'))
              .width(80)
              .height(80)
              .borderRadius(40)
            
            Column() {
              Text('Êú™ÁôªÂΩï')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
              Text('ÁÇπÂáªÁôªÂΩï')
                .fontSize(14)
                .margin({ top: 5 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 20 })
          }
        }
        .width('90%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(10)
        .margin({ bottom: 20 })
        .onClick(() => {
          if (!this.userInfo) {
            router.pushUrl({
              url: 'pages/Login'
            });
          }
        })
        
        // ÂäüËÉΩÂå∫Âüü
        Column() {
          this.buildProfileItem('ÊàëÁöÑÊî∂Ëóè', 'like')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('ÊµèËßàÂéÜÂè≤', 'history')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('ÊàëÁöÑËØÑËÆ∫', 'comment')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('ËÆæÁΩÆ', 'settings')
          
          // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÊòæÁ§∫ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
          if (this.userInfo) {
            Divider().width('100%').height(1).color('#F0F0F0')
            Button('ÈÄÄÂá∫ÁôªÂΩï', { type: ButtonType.Normal })
              .width('100%')
              .height(50)
              .backgroundColor('#8B1A1A')
              .fontColor('#FFFFFF')
              .margin({ top: 20 })
              .onClick(() => {
                this.userService.logout();
                this.userInfo = null;
                router.replaceUrl({ url: 'pages/Login' });
              })
          }
        }
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(10)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
    .padding({ bottom: 56 })
  }

  aboutToAppear() {
    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    this.loadUserInfo();
    
    // Ê∑ªÂä†Á§∫‰æãÂä®ÊÄÅÊï∞ÊçÆ
    this.posts = [
      {
        id: 1,
        username: 'Âº†‰∏â',
        avatarUrl: '',
        content: '‰ªäÂ§©ÂèÇËßÇ‰∫ÜÊïÖÂÆ´ÂçöÁâ©Èô¢ÔºåÁúãÂà∞‰∫ÜÂæàÂ§öÁèçË¥µÁöÑÊñáÁâ©ÔºåÁâπÂà´ÊòØÈùíËä±Áì∑Áì∂ÔºåÁúüÊòØÂ§™Áæé‰∫ÜÔºÅ',
        createTime: '2024-03-20 15:30',
        likes: 12,
        isLiked: false,
        images: [],
        comments: [
          {
            username: 'ÊùéÂõõ',
            content: 'Êàë‰πüÂéªËøáÊïÖÂÆ´ÔºåÁ°ÆÂÆûÂæàÈúáÊíºÔºÅ'
          },
          {
            username: 'Áéã‰∫î',
            content: 'Êé®ËçêÂéªÁúãÁúãÊïÖÂÆ´ÁöÑÈíüË°®È¶ÜÔºå‰πüÂæàÁ≤æÂΩ©ÔºÅ'
          }
        ]
      },
      {
        id: 2,
        username: 'ÊùéÂõõ',
        avatarUrl: '',
        content: 'ÂàÜ‰∫´‰∏ÄÂº†Âú®Âçó‰∫¨ÂçöÁâ©Èô¢ÊãçÁöÑÁÖßÁâáÔºåËøô‰∏™ÈáëÁºïÁéâË°£ÁúüÊòØÂ§™Á≤æÁæé‰∫ÜÔºÅ',
        createTime: '2024-03-19 10:20',
        likes: 8,
        isLiked: false,
        images: [$r('app.media.cultural_heritage_logo')],
        comments: [
          {
            username: 'Âº†‰∏â',
            content: 'Ëøô‰∏™ÁéâË°£‰øùÂ≠òÂæóÁúüÂ•ΩÔºÅ'
          }
        ]
      }
    ];

    // Âä†ËΩΩÊñáÁâ©Êï∞ÊçÆ
    this.loadArtifacts();
  }
  
  private async loadUserInfo() {
    try {
      this.userInfo = await this.userService.getUserInfo();
      console.info('Áî®Êà∑‰ø°ÊÅØÂä†ËΩΩÊàêÂäü:', JSON.stringify(this.userInfo));
    } catch (error) {
      console.error('Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
      this.userInfo = null;
    }
  }

  // Ê∑ªÂä†Âä†ËΩΩÊñáÁâ©ÊñπÊ≥ï
  private loadArtifacts() {
    this.isArtifactsLoading = true;
    
    const categoryId = this.selectedCategory.id === 0 ? undefined : this.selectedCategory.id;
    this.artifactService.getArtifactList(categoryId, 1, 20)
      .then((artifacts) => {
        this.artifacts = artifacts;
        this.isArtifactsLoading = false;
      })
      .catch((err: Error) => {
        console.error('Âä†ËΩΩÊñáÁâ©Â§±Ë¥•:', err);
        this.isArtifactsLoading = false;
      });
  }
}