import { Constants } from '../common/constants/Constants';
import router from '@ohos.router';
import { CategoryItem } from '../common/constants/Constants';
import { Artifact } from '../model/ArtifactModel';
import { ArtifactService } from '../services/ArtifactService';
import prompt from '@ohos.prompt';
import picker from '@ohos.file.picker';
import { UserService } from '../services/UserService';
import { UserInfo } from '../services/UserService';
import { PostService } from '../services/PostService';
import { CommentService } from '../services/CommentService';
import { Post as PostModel, Comment as CommentModel } from '../model/PostModel';
import { CommentData } from '../model/CommentModel';

/**
 * åŠ¨æ€å¸–å­æ¥å£
 */
interface Post {
  id: number;
  username: string;
  avatarUrl: string;
  content: string;
  createTime: string;
  likes: number;
  isLiked: boolean;
  images: Resource[];
  comments: Array<Comment>;
}

/**
 * è¯„è®ºæ¥å£
 */
interface Comment {
  username: string;
  content: string;
}

/**
 * Sheeté¡¹ç›®æ¥å£
 */
interface Sheet {
  title: string;
  action: () => void;
}

/**
 * è¯„è®ºæ•°æ®æ¥å£ï¼Œç”¨äºåˆ›å»ºè¯„è®º
 */
interface CommentInputData {
  comment_id: string;
  post_id: string;
  user_id: number;
  nickname: string;
  img_url?: string;
  content: string;
  create_time: string;
  create_timestamp: number;
}

/**
 * è¯„è®ºå“åº”æ¥å£ï¼Œç”¨äºå¤„ç†æœåŠ¡å™¨è¿”å›çš„è¯„è®ºæ•°æ®
 */
interface CommentResponse {
  comment_id: string;
  post_id: string;
  user_id: number;
  nickname: string;
  img_url?: string;
  content: string;
  create_time: string;
  create_timestamp: number;
}

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State searchKeyword: string = '';
  @State searchResults: Artifact[] = [];
  @State isLoading: boolean = false;
  @State posts: Array<Post> = [];
  @State realPosts: Array<PostModel> = []; // çœŸå®çš„å¸–å­æ•°æ®
  @State favoritePosts: Set<number> = new Set();
  @State selectedImages: Resource[] = [];
  @State newPostContent: string = '';
  @State artifacts: Artifact[] = [];
  @State isArtifactsLoading: boolean = false;
  @State selectedCategory: CategoryItem = { id: 0, name: 'å…¨éƒ¨' };
  @State userInfo: UserInfo | null = null;
  @State isPostsLoading: boolean = false;
  @State showCommentInput: boolean = false;
  @State currentPostId: string = '';
  @State commentContent: string = '';
  @State currentPage: number = 1;
  @State pageSize: number = 10;
  @State hasMoreData: boolean = true;
  
  private artifactService: ArtifactService = new ArtifactService();
  private userService: UserService = new UserService();
  private scroller: Scroller = new Scroller();

  build() {
    Column() {
      // ä¸»ä½“å†…å®¹åŒºåŸŸ
      Tabs({
        barPosition: BarPosition.End,
        controller: new TabsController()
      }) {
        // é¦–é¡µTab
        TabContent() {
          this.buildHomePage()
        }
        .tabBar(this.TabBuilder(0, 'é¦–é¡µ', 'home'))
        
        // æ–‡ç‰©å±•ç¤ºTab
        TabContent() {
          this.buildArtifactsPage()
        }
        .tabBar(this.TabBuilder(1, 'æ–‡ç‰©', 'list'))
        
        // æœç´¢Tab
        TabContent() {
          this.buildSearchPage()
        }
        .tabBar(this.TabBuilder(2, 'æœç´¢', 'search'))
        
        // åŠ¨æ€Tab
        TabContent() {
          this.buildDynamicPage()
        }
        .tabBar(this.TabBuilder(3, 'åŠ¨æ€', 'icon'))
        
        // æˆ‘çš„Tab
        TabContent() {
          this.buildUserProfilePage()
        }
        .tabBar(this.TabBuilder(4, 'æˆ‘çš„', 'person'))
      }
      .width('100%')
      .height('100%')
      .barHeight(56)
      .onChange((index) => {
        this.currentIndex = index
      })
    }
    .width('100%')
    .height('100%')
  }
  
  @Builder
  TabBuilder(index: number, title: string, icon: string) {
    Column() {
      Image($r(`app.media.${icon}`))
        .width(24)
        .height(24)
        .fillColor(this.currentIndex === index ? '#1698CE' : '#666666')
      Text(title)
        .fontSize(12)
        .fontColor(this.currentIndex === index ? '#1698CE' : '#666666')
        .margin({ top: 4 })
    }
    .width(56)
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }
  
  @Builder
  buildHomePage() {
    Scroll() {
      Column() {
        Text('æŒä¸Šåšç‰©é¦†')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .margin({ top: 20, bottom: 20 })
        
        // è½®æ’­å›¾
        Swiper() {
          // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è½®æ’­å›¾å†…å®¹
          Text('è½®æ’­å›¾1').width('100%').height(200).backgroundColor('#66CCFF')
          Text('è½®æ’­å›¾2').width('100%').height(200).backgroundColor('#6699FF')
          Text('è½®æ’­å›¾3').width('100%').height(200).backgroundColor('#66CCCC')
        }
        .autoPlay(true)
        .interval(3000)
        .width('90%')
        .height(200)
        .borderRadius(10)
        .margin({ bottom: 20 })
        
        // åˆ†ç±»åŒºåŸŸ
        Text('æ–‡ç‰©åˆ†ç±»').fontSize(20).fontWeight(FontWeight.Bold).alignSelf(ItemAlign.Start).margin({ left: 16, top: 10, bottom: 10 })
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceAround }) {
          ForEach(Constants.ARTIFACT_CATEGORIES, (category: CategoryItem) => {
            Column() {
              // è¿™é‡Œåº”åŠ å…¥å®é™…çš„å›¾æ ‡
              Image($r('app.media.icon'))
                .width(50)
                .height(50)
                .margin({ bottom: 5 })
              Text(category.name)
                .fontSize(14)
            }
            .width('30%')
            .aspectRatio(1)
            .margin(5)
            .borderRadius(8)
            .backgroundColor('#F5F5F5')
            .justifyContent(FlexAlign.Center)
          })
        }
        .padding(10)
        
        // æ¨èæ–‡ç‰©
        Text('æ¨èæ–‡ç‰©').fontSize(20).fontWeight(FontWeight.Bold).alignSelf(ItemAlign.Start).margin({ left: 16, top: 16, bottom: 10 })
        List({ space: 10 }) {
          // è¿™é‡Œåº”åŠ å…¥å®é™…çš„æ–‡ç‰©æ•°æ®
          ListItem() {
            Row() {
              Image($r('app.media.icon'))
                .width(80)
                .height(80)
                .borderRadius(5)
              Column() {
                Text('é’èŠ±ç“·ç“¶').fontSize(16).fontWeight(FontWeight.Bold)
                Text('æ˜æœ').fontSize(14).margin({ top: 5 })
                Text('å¤§è‹±åšç‰©é¦†').fontSize(14).margin({ top: 5 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
              .layoutWeight(1)
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
          
          ListItem() {
            Row() {
              Image($r('app.media.icon'))
                .width(80)
                .height(80)
                .borderRadius(5)
              Column() {
                Text('ç‰å™¨æ‘†ä»¶').fontSize(16).fontWeight(FontWeight.Bold)
                Text('æ¸…æœ').fontSize(14).margin({ top: 5 })
                Text('å¤§éƒ½ä¼šåšç‰©é¦†').fontSize(14).margin({ top: 5 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 10 })
              .layoutWeight(1)
            }
            .width('100%')
            .padding(10)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
        }
        .width('90%')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F0F0F0')
      .padding({ bottom: 56 })
    }
    .scrollBar(BarState.Off)
    .width('100%')
    .height('100%')
  }
  
  @Builder
  buildArtifactsPage() {
    Column() {
      Text('æ–‡ç‰©å±•ç¤º').fontSize(24).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 20 })
      
      // æ·»åŠ åˆ†ç±»é€‰æ‹©å™¨
      Row() {
        Text('åˆ†ç±»ï¼š').fontSize(16).fontColor('#666666')
        
        Row() {
          Text(this.selectedCategory.name)
            .fontSize(16)
            .fontColor('#1698CE')
            .layoutWeight(1)
          
          Image($r('app.media.arrow_right'))
            .width(20)
            .height(20)
            .fillColor('#1698CE')
            .margin({ left: 5 })
        }
        .width('80%')
        .height(40)
        .borderRadius(20)
        .backgroundColor('#F5F5F5')
        .padding({ left: 15, right: 15 })
        .justifyContent(FlexAlign.SpaceBetween)
        .onClick(() => {
          ActionSheet.show({
            title: 'é€‰æ‹©åˆ†ç±»',
            message: 'è¯·é€‰æ‹©æ‚¨æƒ³è¦æŸ¥çœ‹çš„æ–‡ç‰©åˆ†ç±»',
            sheets: Constants.ARTIFACT_CATEGORIES.map((item): Sheet => ({
              title: item.name,
              action: () => {
                this.selectedCategory = item;
                this.loadArtifacts();
              }
            }))
          });
        })
      }
      .width('90%')
      .margin({ bottom: 20 })
      
      // åŠ è½½çŠ¶æ€
      if (this.isArtifactsLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1698CE')
          
          Text('æ­£åœ¨åŠ è½½æ–‡ç‰©æ•°æ®...')
            .fontSize(16)
            .margin({ top: 10 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } 
      // æ–‡ç‰©åˆ—è¡¨
      else if (this.artifacts.length > 0) {
        Grid() {
          ForEach(this.artifacts, (artifact: Artifact) => {
            GridItem() {
              Column() {
                // æ–‡ç‰©å›¾ç‰‡
                Stack() {
                  Image(artifact.imageUrl || $r('app.media.placeholder'))
                    .width('100%')
                    .height(180)
                    .objectFit(ImageFit.Cover)
                    .borderRadius({ topLeft: 8, topRight: 8 })

                }
                .width('100%')
                
                // æ–‡ç‰©ä¿¡æ¯
                Column() {
                  Text(artifact.name)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .width('100%')

                  Row() {
                    Text(`${artifact.era}`)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ right: 8 })
                    Text(artifact.museum)
                      .fontSize(14)
                      .fontColor('#666666')
                      .backgroundColor('#00000010')
                      .borderRadius(10)
                      .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                      .margin({ right: 8 })
                  }
                  .width('100%')
                  .margin({ top: 5 })
                }
                .width('100%')
                .padding(10)
              }
              .width('100%')
              .backgroundColor('#FFFFFF')
              .borderRadius(8)
              .onClick(() => {
                router.pushUrl({
                  url: 'pages/ArtifactDetail',
                  params: { artifactId: artifact.id }
                });
              })
            }
            .aspectRatio(0.75)  // å®½é«˜æ¯”
          })
        }
        .columnsTemplate('1fr 1fr')  // ä¸¤åˆ—å¸ƒå±€
        .columnsGap(12)  // åˆ—é—´è·ï¼ˆå¯é€‚å½“åŠ å¤§ï¼‰
        .rowsGap(12)  // è¡Œé—´è·ï¼ˆå¯é€‚å½“åŠ å¤§ï¼‰
        .width('100%')  // è¿™é‡Œæ”¹æˆ100%
        .layoutWeight(1)
      } 
      // æ— æ•°æ®çŠ¶æ€
      else {
        Column() {
          Image($r('app.media.no_result'))
            .width(100)
            .height(100)
            .margin({ bottom: 20 })
          
          Text('æš‚æ— æ–‡ç‰©æ•°æ®')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
    .padding({ bottom: 56 })
  }
  
  @Builder
  buildSearchPage() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($r('app.media.background2'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .opacity(0.1)

      Column() {
        Text('æ–‡ç‰©æœç´¢')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#8B0000')  // æ·±çº¢è‰²
          .margin({ top: 20, bottom: 20 })
        
        // æœç´¢æ¡†
        Row() {
          TextInput({ placeholder: 'è¾“å…¥å…³é”®è¯æœç´¢æ–‡ç‰©' })
            .width('80%')
            .height(40)
            .backgroundColor('#FFFFFF')
            .borderRadius(20)
            .padding({ left: 15, right: 15 })
            .borderColor('#8B0000')
            .borderWidth(1)
            .onChange((value: string) => {
              this.searchKeyword = value;
            })
          
          Image($r('app.media.search'))
            .width(24)
            .height(24)
            .margin({ left: 10 })
            .fillColor('#8B0000')  // æ·±çº¢è‰²
            .onClick(() => {
              this.performSearch();
            })
        }
        .width('90%')
        .margin({ bottom: 20 })
        
        Divider()
          .width('90%')
          .color('#8B0000')  // æ·±çº¢è‰²
          .margin({ top: 5, bottom: 5 })
        
        // å›¾åƒæœç´¢æŒ‰é’®
        Button('æ‹ç…§æœç´¢æ–‡ç‰©', { type: ButtonType.Normal })
          .width('80%')
          .height(50)
          .backgroundColor('#8B0000')  // æ·±çº¢è‰²
          .fontColor('#FFFFFF')
          .borderRadius(25)
          .margin({ top: 20 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/ImageSearch'
            });
          })
        
        // æœç´¢ç»“æœåŒºåŸŸ
        if (this.isLoading) {
          Column() {
            LoadingProgress()
              .width(50)
              .height(50)
              .color('#8B0000')  // æ·±çº¢è‰²
              .margin({ bottom: 20 })
            
            Text('æ­£åœ¨æœç´¢ä¸­...')
              .fontSize(18)
              .fontColor('#8B0000')  // æ·±çº¢è‰²
              .margin({ bottom: 10 })
            
            Text('è¯·ç¨å€™ï¼Œæˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨æŸ¥æ‰¾ç›¸å…³æ–‡ç‰©')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(15)
          .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
          .margin({ top: 20 })
        } else if (this.searchResults.length > 0) {
          Text('æœç´¢ç»“æœ')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#8B0000')  // æ·±çº¢è‰²
            .alignSelf(ItemAlign.Start)
            .margin({ left: '5%', top: 20, bottom: 10 })
          
          List({ space: 10 }) {
            ForEach(this.searchResults, (artifact: Artifact) => {
              ListItem() {
                Row() {
                  Image(artifact.imageUrl || $r('app.media.placeholder'))
                    .width(100)
                    .height(100)
                    .borderRadius(10)
                    .objectFit(ImageFit.Cover)
                    .border({ width: 1, color: '#8B0000' })  // æ·±çº¢è‰²è¾¹æ¡†
                  
                  Column() {
                    Text(artifact.name)
                      .fontSize(18)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#8B0000')  // æ·±çº¢è‰²
                    
                    Text(artifact.era)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 5 })
                    
                    Text(artifact.museum)
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ top: 5 })
                  }
                  .alignItems(HorizontalAlign.Start)
                  .margin({ left: 15 })
                  .layoutWeight(1)
                }
                .width('100%')
                .padding(15)
                .backgroundColor('#FFFFFF')
                .borderRadius(15)
                .border({ width: 1, color: '#8B0000' })  // æ·±çº¢è‰²è¾¹æ¡†
                .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/ArtifactDetail',
                    params: { artifactId: artifact.id }
                  });
                })
              }
            })
          }
          .width('90%')
          .layoutWeight(1)
        } else if (this.searchKeyword) {
          Column() {
            Image($r('app.media.no_result'))
              .width(100)
              .height(100)
              .margin({ bottom: 16 })
              .fillColor('#8B0000')  // æ·±çº¢è‰²
              
            Text('æŠ±æ­‰ï¼Œæœªæ‰¾åˆ°ç›¸å…³æ–‡ç‰©')
              .fontSize(18)
              .fontColor('#8B0000')  // æ·±çº¢è‰²
              .margin({ bottom: 10 })
            
            Text('è¯·å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯è¿›è¡Œæœç´¢')
              .fontSize(14)
              .fontColor('#666666')
          }
          .width('100%')
          .height(200)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#FFFFFF')
          .borderRadius(15)
          .border({ width: 1, color: '#8B0000' })  // æ·±çº¢è‰²è¾¹æ¡†
          .shadow({ radius: 3, color: '#8B0000', offsetX: 0, offsetY: 2 })
          .margin({ top: 20 })
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF5F5')  // æµ…çº¢è‰²èƒŒæ™¯
    .padding({ bottom: 56 })
  }
  
  private performSearch(): void {
    if (!this.searchKeyword.trim()) {
      prompt.showToast({ message: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯' });
      return;
    }
    
    this.isLoading = true;
    this.artifactService.searchByKeyword(this.searchKeyword)
      .then((artifacts: Artifact[]) => {
        this.searchResults = artifacts;
        this.isLoading = false;
      })
      .catch((error: Error) => {
        this.isLoading = false;
        prompt.showToast({ message: `æœç´¢å¤±è´¥: ${error.message}` });
      });
  }
  
  @Builder
  buildProfileItem(title: string, icon: string) {
    Row() {
      Row() {
        // å·¦ä¾§å›¾æ ‡
        Image($r(`app.media.${icon}`))
          .width(24)
          .height(24)
          .fillColor('#666666')
        
        // æ ‡é¢˜æ–‡å­—
        Text(title)
          .fontSize(16)
          .fontColor('#333333')
          .margin({ left: 12 })
      }
      .layoutWeight(1)
      .alignItems(VerticalAlign.Center)
      
      // å³ä¾§ç®­å¤´
      Image($r('app.media.arrow_right'))
        .width(20)
        .height(20)
        .fillColor('#999999')
    }
    .width('100%')
    .padding({ top: 16, bottom: 16, left: 8, right: 8 })
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      if (title === 'è®¾ç½®') {
        router.pushUrl({
          url: 'pages/Settings'
        });
      } else if (title === 'æˆ‘çš„æ”¶è—') {
        router.pushUrl({
          url: 'pages/Favorites'
        });
      } else if (title === 'æµè§ˆå†å²') {
        router.pushUrl({
          url: 'pages/History'
        });
      } else if (title === 'æˆ‘çš„è¯„è®º') {
        router.pushUrl({
          url: 'pages/Comments'
        });
      }
    })
  }
  
  @Builder
  buildDynamicPage() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Text('ç¤¾åŒºåŠ¨æ€')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        
        // å‘è¡¨åŠ¨æ€æŒ‰é’®
        Button('å‘è¡¨', { type: ButtonType.Normal })
          .width(60)
          .height(30)
          .backgroundColor('#1698CE')
          .fontColor('#FFFFFF')
          .borderRadius(15)
          .onClick(() => {
            router.pushUrl({
              url: 'pages/Dynamic',
              params: {
                isPostOnly: true // æ ‡è®°ä»…ç”¨äºå‘è¡¨å¸–å­
              }
            });
          })
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      .backgroundColor('#FFFFFF')
      .borderRadius({ bottomLeft: 10, bottomRight: 10 })
      .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 2 })

      // ä¸‹æ‹‰åˆ·æ–°æç¤º
      if (this.isPostsLoading && this.realPosts.length === 0) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1698CE')
          
          Text('æ­£åœ¨åŠ è½½åŠ¨æ€å†…å®¹...')
            .fontSize(16)
            .margin({ top: 10 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } 
      // åŠ¨æ€åˆ—è¡¨
      else if (this.realPosts.length === 0) {
        Column() {
          Image($r('app.media.empty_image'))
            .width(100)
            .height(100)
            .margin({ bottom: 20 })
          
          Text('æš‚æ— åŠ¨æ€å†…å®¹')
            .fontSize(16)
            .fontColor('#999999')
            .margin({ bottom: 10 })
          
          Button('å»å‘è¡¨ç¬¬ä¸€æ¡åŠ¨æ€', { type: ButtonType.Normal })
            .backgroundColor('#1698CE')
            .fontColor('#FFFFFF')
            .borderRadius(20)
            .onClick(() => {
              router.pushUrl({
                url: 'pages/Dynamic',
                params: {
                  isPostOnly: true // æ ‡è®°ä»…ç”¨äºå‘è¡¨å¸–å­
                }
              });
            })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        List({ space: 10, scroller: this.scroller }) {
          ForEach(this.realPosts, (post: PostModel, index: number) => {
          ListItem() {
              this.RealPostBuilder(post, index)
          }
        })
          
          // åŠ è½½ä¸­æç¤º
          if (this.isPostsLoading) {
            ListItem() {
              Row() {
                LoadingProgress()
                  .width(24)
                  .height(24)
                  .color('#1698CE')
                Text('åŠ è½½ä¸­...')
                  .fontSize(14)
                  .fontColor('#999999')
                  .margin({ left: 10 })
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
              .padding(16)
            }
          }
          
          // æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º
          if (!this.hasMoreData && this.realPosts.length > 0) {
            ListItem() {
              Text('å·²ç»åˆ°åº•äº†')
                .fontSize(14)
                .fontColor('#999999')
                .width('100%')
                .textAlign(TextAlign.Center)
                .padding(16)
            }
          }
      }
      .width('100%')
      .layoutWeight(1)
        .onReachEnd(() => {
          if (!this.isPostsLoading && this.hasMoreData) {
            this.loadPosts();
          }
        })
        .onScrollFrameBegin((offset: number) => {
          if (offset <= -100 && !this.isPostsLoading) {
            this.loadPosts(true);
          }
          return { offsetRemain: 0 };
        })
      }
      
      // è¯„è®ºè¾“å…¥æ¡†
      if (this.showCommentInput) {
        Column() {
          Row() {
            TextInput({ placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...', text: this.commentContent })
              .width('75%')
              .height(40)
              .backgroundColor('#F5F5F5')
              .borderRadius(20)
              .padding({ left: 12, right: 12 })
              .onChange((value: string) => {
                this.commentContent = value;
              })

            Button('å‘é€', { type: ButtonType.Normal })
              .width('20%')
              .height(40)
              .backgroundColor('#1698CE')
              .fontColor('#FFFFFF')
              .borderRadius(20)
              .onClick(() => {
                this.addComment(this.currentPostId);
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .padding(16)
        }
        .width('100%')
        .backgroundColor('#FFFFFF')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
    .padding({ bottom: 56 })
  }
  
  @Builder
  RealPostBuilder(post: PostModel, index: number) {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯å’Œå‘å¸ƒæ—¶é—´
      Row() {
        // ç”¨æˆ·å¤´åƒ
        Image(post.img_url || $r('app.media.icon'))
          .width(40)
          .height(40)
          .borderRadius(20)
          .margin({ right: 10 })
        
        Column() {
          // ç”¨æˆ·æ˜µç§°
          Text(post.nickname)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
          
          // å‘å¸ƒæ—¶é—´
          Text(post.create_time)
            .fontSize(12)
            .fontColor('#999999')
        }
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // åŠ¨æ€å†…å®¹
      Text(post.content)
        .fontSize(16)
        .width('100%')
        .margin({ bottom: 10 })

      // å›¾ç‰‡å±•ç¤º
      if (post.post_img_url) {
        Image(post.post_img_url)
                .width('100%')
          .height(200)
                .objectFit(ImageFit.Cover)
                .borderRadius(8)
        .margin({ bottom: 10 })
      }

      // æ“ä½œæ 
      Row() {
        // ç‚¹èµæŒ‰é’®
        Row() {
          Text(post.is_favorited === 1 ? 'â™¥' : 'â™¡')
            .fontSize(20)
            .fontColor(post.is_favorited === 1 ? '#FF0000' : '#666666')
          Text(post.likes.toString())
            .fontSize(14)
            .margin({ left: 5 })
        }
        .onClick(() => {
          this.likePost(post, index);
        })
        .margin({ right: 20 })

        // è¯„è®ºæŒ‰é’®
        Row() {
          Text('ğŸ’¬')
            .fontSize(20)
          Text(post.comments ? post.comments.length.toString() : '0')
            .fontSize(14)
            .margin({ left: 5 })
        }
        .onClick(() => {
          this.currentPostId = post.post_id;
          this.showCommentInput = true;
        })
        .margin({ right: 20 })

        // æ”¶è—æŒ‰é’®
        Row() {
          Text(post.is_favorited === 1 ? 'â˜…' : 'â˜†')
            .fontSize(20)
            .fontColor(post.is_favorited === 1 ? '#FFD700' : '#666666')
        }
        .onClick(() => {
          this.toggleFavorite(post, index);
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
      .margin({ bottom: 10 })

      // è¯„è®ºåˆ—è¡¨
      if (post.comments && post.comments.length > 0) {
        Column() {
          ForEach(post.comments, (comment: CommentModel) => {
            Row() {
              Text(comment.nickname || 'åŒ¿åç”¨æˆ·')
                    .fontSize(14)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1698CE')
              Text(comment.content || '')
                    .fontSize(14)
                    .margin({ left: 5 })
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 5 })
          })
        }
        .width('100%')
        .padding(10)
        .backgroundColor('#F5F5F5')
        .borderRadius(5)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(10)
    .margin({ bottom: 10 })
  }
  
  // æ·»åŠ ç‚¹èµæ–¹æ³•
  async likePost(post: PostModel, index: number) {
    try {
      if (post.is_favorited === 1) {
        const result = await PostService.unlikePost(post.post_id);
        if (result.code === 0 && result.data) {
          this.realPosts[index].likes = result.data.likes;
          this.realPosts[index].is_favorited = 0;
          this.realPosts = [...this.realPosts]; // è§¦å‘UIæ›´æ–°
        }
      } else {
        const result = await PostService.likePost(post.post_id);
        if (result.code === 0 && result.data) {
          this.realPosts[index].likes = result.data.likes;
          this.realPosts[index].is_favorited = 1;
          this.realPosts = [...this.realPosts]; // è§¦å‘UIæ›´æ–°
        }
      }
    } catch (error) {
      console.error('æ›´æ–°ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
      prompt.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    }
  }

  // æ·»åŠ æ”¶è—/å–æ¶ˆæ”¶è—æ–¹æ³•
  async toggleFavorite(post: PostModel, index: number) {
    try {
      const newState = post.is_favorited === 0;
      const result = await PostService.updateFavorite(post.post_id, newState);
      if (result.code === 0 && result.data !== undefined) {
        this.realPosts[index].is_favorited = result.data.is_favorited ? 1 : 0;
        this.realPosts = [...this.realPosts]; // è§¦å‘UIæ›´æ–°
        prompt.showToast({ message: result.data.is_favorited ? 'æ”¶è—æˆåŠŸ' : 'å–æ¶ˆæ”¶è—æˆåŠŸ' });
      }
    } catch (error) {
      console.error('æ›´æ–°æ”¶è—çŠ¶æ€å¤±è´¥:', error);
      prompt.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    }
  }

  // æ·»åŠ è¯„è®ºæ–¹æ³•
  async addComment(postId: string) {
    if (!this.commentContent.trim()) {
      prompt.showToast({ message: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹' });
      return;
    }

    try {
      const userInfo = await this.userService.getUserInfo();
      if (!userInfo) {
        prompt.showToast({ message: 'è¯·å…ˆç™»å½•' });
        return;
      }

      // è·å–ç”¨æˆ·IDï¼Œå°è¯•ä¸åŒçš„å±æ€§
      const userId = userInfo.user_id || (userInfo.id ? parseInt(userInfo.id) : 0);
      const nickname = userInfo.nickname || 'åŒ¿åç”¨æˆ·';
      
      const now = new Date();
      const commentData: CommentData = {
        comment_id: `comment_${now.getTime()}`,
        post_id: postId,
        user_id: userId,
        nickname: nickname,
        img_url: userInfo.img_url,
        content: this.commentContent,
        create_time: this.formatDate(now, 'YYYY-MM-DD HH:mm:ss'),
        create_timestamp: now.getTime()
      };

      const result = await CommentService.addComment(commentData);
      if (result.code === 0 && result.data) {
        prompt.showToast({ message: 'è¯„è®ºæˆåŠŸ' });
        this.commentContent = '';
        this.showCommentInput = false;
        
        // æ›´æ–°æœ¬åœ°å¸–å­è¯„è®ºæ•°æ®
        const postIndex = this.realPosts.findIndex(post => post.post_id === postId);
        if (postIndex !== -1 && this.realPosts[postIndex]) {
          // ç¡®ä¿commentsæ•°ç»„å·²åˆå§‹åŒ–
          if (!this.realPosts[postIndex].comments) {
            this.realPosts[postIndex].comments = [];
          }
          
          // åˆ›å»ºä¸€ä¸ªæ˜ç¡®çš„CommentModelå¯¹è±¡ï¼Œé¿å…ç»“æ„ç±»å‹
          const newComment: CommentModel = {
            comment_id: result.data.comment_id,
            post_id: result.data.post_id,
            user_id: result.data.user_id,
            nickname: result.data.nickname,
            content: result.data.content,
            create_time: result.data.create_time,
            create_timestamp: result.data.create_timestamp
          };
          
          // å¯é€‰å±æ€§å•ç‹¬å¤„ç†
          if (result.data.img_url) {
            newComment.img_url = result.data.img_url;
          }
          
          // ç›´æ¥ä½¿ç”¨commentsæ•°ç»„ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç¡®ä¿å®ƒå­˜åœ¨
          this.realPosts[postIndex].comments!.unshift(newComment);
          this.realPosts = [...this.realPosts]; // è§¦å‘UIæ›´æ–°
        }
      } else {
        prompt.showToast({ message: result.message || 'è¯„è®ºå¤±è´¥' });
      }
    } catch (error) {
      console.error('å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
      prompt.showToast({ message: 'è¯„è®ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    }
  }

  // åŠ è½½å¸–å­æ–¹æ³•
  async loadPosts(isRefresh: boolean = false) {
    if (isRefresh) {
      this.currentPage = 1;
    }
    
    if (!this.hasMoreData && !isRefresh) {
      return;
    }

    this.isPostsLoading = true;
    try {
      const response = await PostService.getPosts(this.currentPage, this.pageSize);
      
      if (isRefresh) {
        this.realPosts = response.data;
      } else {
        this.realPosts = [...this.realPosts, ...response.data];
      }
      
      this.hasMoreData = this.realPosts.length < response.total;
      this.currentPage++;
    } catch (error) {
      console.error('è·å–å¸–å­åˆ—è¡¨å¤±è´¥:', error);
      prompt.showToast({ message: 'è·å–å¸–å­å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' });
    } finally {
      this.isPostsLoading = false;
    }
  }

  // æ—¥æœŸæ ¼å¼åŒ–æ–¹æ³•
  private formatDate(date: Date, format: string): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return format
      .replace('YYYY', String(year))
      .replace('MM', month)
      .replace('DD', day)
      .replace('HH', hours)
      .replace('mm', minutes)
      .replace('ss', seconds);
  }

  aboutToAppear() {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    this.loadUserInfo();
    
    // åŠ è½½å¸–å­æ•°æ®
    this.loadPosts();
    
    // ç¤ºä¾‹åŠ¨æ€æ•°æ® - ä½ å¯ä»¥ä¿ç•™è¿™éƒ¨åˆ†ä½œä¸ºå¤‡ç”¨
    this.posts = [
      {
        id: 1,
        username: 'å¼ ä¸‰',
        avatarUrl: '',
        content: 'ä»Šå¤©å‚è§‚äº†æ•…å®«åšç‰©é™¢ï¼Œçœ‹åˆ°äº†å¾ˆå¤šçè´µçš„æ–‡ç‰©ï¼Œç‰¹åˆ«æ˜¯é’èŠ±ç“·ç“¶ï¼ŒçœŸæ˜¯å¤ªç¾äº†ï¼',
        createTime: '2024-03-20 15:30',
        likes: 12,
        isLiked: false,
        images: [],
        comments: [
          {
            username: 'æå››',
            content: 'æˆ‘ä¹Ÿå»è¿‡æ•…å®«ï¼Œç¡®å®å¾ˆéœ‡æ’¼ï¼'
          },
          {
            username: 'ç‹äº”',
            content: 'æ¨èå»çœ‹çœ‹æ•…å®«çš„é’Ÿè¡¨é¦†ï¼Œä¹Ÿå¾ˆç²¾å½©ï¼'
          }
        ]
      },
      {
        id: 2,
        username: 'æå››',
        avatarUrl: '',
        content: 'åˆ†äº«ä¸€å¼ åœ¨å—äº¬åšç‰©é™¢æ‹çš„ç…§ç‰‡ï¼Œè¿™ä¸ªé‡‘ç¼•ç‰è¡£çœŸæ˜¯å¤ªç²¾ç¾äº†ï¼',
        createTime: '2024-03-19 10:20',
        likes: 8,
        isLiked: false,
        images: [$r('app.media.cultural_heritage_logo')],
        comments: [
          {
            username: 'å¼ ä¸‰',
            content: 'è¿™ä¸ªç‰è¡£ä¿å­˜å¾—çœŸå¥½ï¼'
          }
        ]
      }
    ];

    // åŠ è½½æ–‡ç‰©æ•°æ®
    this.loadArtifacts();
  }
  
  private async loadUserInfo() {
    try {
      this.userInfo = await this.userService.getUserInfo();
      console.info('ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', JSON.stringify(this.userInfo));
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      this.userInfo = null;
    }
  }

  // æ·»åŠ åŠ è½½æ–‡ç‰©æ–¹æ³•
  private loadArtifacts() {
    this.isArtifactsLoading = true;
    
    const categoryId = this.selectedCategory.id === 0 ? undefined : this.selectedCategory.id;
    this.artifactService.getArtifactList(categoryId, 1, 20)
      .then((artifacts) => {
        this.artifacts = artifacts;
        this.isArtifactsLoading = false;
      })
      .catch((err: Error) => {
        console.error('åŠ è½½æ–‡ç‰©å¤±è´¥:', err);
        this.isArtifactsLoading = false;
      });
  }
  
  @Builder
  buildUserProfilePage() {
    Column() {
      Text('ä¸ªäººä¸­å¿ƒ').fontSize(24).fontWeight(FontWeight.Bold).margin({ top: 20, bottom: 20 })
      
      Column() {
        // ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
        Row() {
          if (this.userInfo) {
            // æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
            Image(this.userInfo.img_url || $r('app.media.icon'))
              .width(80)
              .height(80)
              .borderRadius(40)
              .objectFit(ImageFit.Cover)
            
            Column() {
              Text(this.userInfo.nickname || 'æœªè®¾ç½®æ˜µç§°')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
              Text(this.userInfo.phone || 'æœªç»‘å®šæ‰‹æœºå·')
                .fontSize(14)
                .margin({ top: 5 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 20 })
          } else {
            // æœªç™»å½•çŠ¶æ€
            Image($r('app.media.icon'))
              .width(80)
              .height(80)
              .borderRadius(40)
            
            Column() {
              Text('æœªç™»å½•')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
              Text('ç‚¹å‡»ç™»å½•')
                .fontSize(14)
                .margin({ top: 5 })
            }
            .alignItems(HorizontalAlign.Start)
            .margin({ left: 20 })
          }
        }
        .width('90%')
        .padding(16)
        .backgroundColor('#FFFFFF')
        .borderRadius(10)
        .margin({ bottom: 20 })
        .onClick(() => {
          if (!this.userInfo) {
            router.pushUrl({
              url: 'pages/Login'
            });
          }
        })
        
        // åŠŸèƒ½åŒºåŸŸ
        Column() {
          this.buildProfileItem('æˆ‘çš„æ”¶è—', 'like')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('æµè§ˆå†å²', 'history')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('æˆ‘çš„è¯„è®º', 'comment')
          Divider().width('100%').height(1).color('#F0F0F0')
          this.buildProfileItem('è®¾ç½®', 'settings')
          
          // å¦‚æœå·²ç™»å½•ï¼Œæ˜¾ç¤ºé€€å‡ºç™»å½•æŒ‰é’®
          if (this.userInfo) {
            Divider().width('100%').height(1).color('#F0F0F0')
            Button('é€€å‡ºç™»å½•', { type: ButtonType.Normal })
              .width('100%')
              .height(50)
              .backgroundColor('#8B1A1A')
              .fontColor('#FFFFFF')
              .margin({ top: 20 })
              .onClick(() => {
                this.userService.logout();
                this.userInfo = null;
                router.replaceUrl({ url: 'pages/Login' });
              })
          }
        }
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(10)
        .padding(16)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F0F0F0')
    .padding({ bottom: 56 })
  }
}