import router from '@ohos.router';
import prompt from '@ohos.prompt';
import { PostService } from '../services/PostService';
import { CommentService } from '../services/CommentService';
import { Post, Comment } from '../model/PostModel';
import { CommentData } from '../model/CommentModel';
import { formatDate } from '../utils/DateUtils';
import { getUserInfo } from '../utils/UserUtils';

/**
 * è·¯ç”±å‚æ•°æŽ¥å£
 */
interface RouteParams {
  postId: string;
}

@Entry
@Component
struct PostDetail {
  @State post: Post | null = null;
  @State comments: Comment[] = [];
  @State isLoading: boolean = true;
  @State isLoadingComments: boolean = false;
  @State commentContent: string = '';
  @State isSubmittingComment: boolean = false;

  aboutToAppear() {
    const params = router.getParams() as RouteParams;
    if (params && params.postId) {
      this.loadPostDetail(params.postId);
      this.loadComments(params.postId);
    } else {
      prompt.showToast({ message: 'å‚æ•°é”™è¯¯ï¼Œæ— æ³•åŠ è½½å¸–å­' });
      setTimeout(() => {
        router.back();
      }, 1000);
    }
  }

  /**
   * åŠ è½½å¸–å­è¯¦æƒ…
   * @param postId å¸–å­ID
   */
  async loadPostDetail(postId: string) {
    try {
      this.isLoading = true;
      const postData = await PostService.getPostById(postId);
      if (postData) {
        this.post = postData;
      } else {
        prompt.showToast({ message: 'å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤' });
        setTimeout(() => {
          router.back();
        }, 1000);
      }
    } catch (error) {
      console.error('åŠ è½½å¸–å­è¯¦æƒ…å¤±è´¥:', error);
      prompt.showToast({ message: 'åŠ è½½å¸–å­å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
    } finally {
      this.isLoading = false;
    }
  }

  /**
   * åŠ è½½è¯„è®ºåˆ—è¡¨
   * @param postId å¸–å­ID
   */
  async loadComments(postId: string) {
    try {
      this.isLoadingComments = true;
      const result = await PostService.getComments(postId);
      if (result.code === 0 && result.data) {
        this.comments = result.data;
      } else {
        console.error('èŽ·å–è¯„è®ºåˆ—è¡¨å¤±è´¥:', result.message);
      }
    } catch (error) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
    } finally {
      this.isLoadingComments = false;
    }
  }

  /**
   * å‘è¡¨è¯„è®º
   */
  async submitComment() {
    if (!this.commentContent.trim()) {
      prompt.showToast({ message: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹' });
      return;
    }

    try {
      this.isSubmittingComment = true;
      const userInfo = await getUserInfo();
      if (!userInfo) {
        prompt.showToast({ message: 'è¯·å…ˆç™»å½•åŽå†è¯„è®º' });
        this.isSubmittingComment = false;
        return;
      }

      const now = new Date();
      const commentData: CommentData = {
        comment_id: `comment_${now.getTime()}`,
        post_id: this.post?.post_id || '',
        user_id: userInfo.user_id,
        nickname: userInfo.nickname,
        img_url: userInfo.img_url,
        content: this.commentContent,
        create_time: formatDate(now, 'YYYY-MM-DD HH:mm:ss'),
        create_timestamp: now.getTime()
      };

      const result = await CommentService.addComment(commentData);
      if (result.code === 0 && result.data) {
        prompt.showToast({ message: 'è¯„è®ºå‘è¡¨æˆåŠŸ' });
        this.commentContent = '';
        // åˆ·æ–°è¯„è®ºåˆ—è¡¨
        this.loadComments(this.post?.post_id || '');
      } else {
        prompt.showToast({ 
          message: result.message || 'è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•',
          duration: 3000
        });
      }
    } catch (error) {
      console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', error);
      prompt.showToast({ message: 'è¯„è®ºå‘è¡¨å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
    } finally {
      this.isSubmittingComment = false;
    }
  }

  /**
   * ç‚¹èµž/å–æ¶ˆç‚¹èµž
   */
  async toggleLike() {
    if (!this.post) return;
    
    try {
      if (this.post.is_favorited === 1) {
        const result = await PostService.unlikePost(this.post.post_id);
        if (result.code === 0 && result.data) {
          this.post.likes = result.data.likes;
          this.post.is_favorited = 0;
          prompt.showToast({ message: 'å·²å–æ¶ˆç‚¹èµž' });
        } else {
          prompt.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
        }
      } else {
        const result = await PostService.likePost(this.post.post_id);
        if (result.code === 0 && result.data) {
          this.post.likes = result.data.likes;
          this.post.is_favorited = 1;
          prompt.showToast({ message: 'ç‚¹èµžæˆåŠŸ' });
        } else {
          prompt.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
        }
      }
    } catch (error) {
      console.error('ç‚¹èµžæ“ä½œå¤±è´¥:', error);
      prompt.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ 
      Row() {
        Image($r('app.media.back'))
          .width(24)
          .height(24)
          .onClick(() => {
            router.back();
          })
        
        Text('å¸–å­è¯¦æƒ…')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      // å†…å®¹åŒºåŸŸ
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(50)
            .height(50)
            .color('#1698CE')
          
          Text('æ­£åœ¨åŠ è½½...')
            .fontSize(16)
            .margin({ top: 10 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else if (this.post) {
        Scroll() {
          Column() {
            // å¸–å­å†…å®¹å¡ç‰‡
            Column() {
              // ç”¨æˆ·ä¿¡æ¯å’Œå‘å¸ƒæ—¶é—´
              Row() {
                Image(this.post.img_url || $r('app.media.icon'))
                  .width(40)
                  .height(40)
                  .borderRadius(20)
                  .margin({ right: 10 })
                
                Column() {
                  Text(this.post.nickname)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                  
                  Text(this.post.create_time)
                    .fontSize(12)
                    .fontColor('#999999')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .margin({ bottom: 16 })

              // å¸–å­å†…å®¹
              Text(this.post.content)
                .fontSize(16)
                .width('100%')
                .margin({ bottom: 16 })

              // å¸–å­å›¾ç‰‡
              if (this.post.post_img_url) {
                Image(this.post.post_img_url)
                  .width('100%')
                  .aspectRatio(1.5)
                  .objectFit(ImageFit.Cover)
                  .borderRadius(8)
                  .margin({ bottom: 16 })
              }

              // äº¤äº’æ•°æ®
              Row() {
                Row() {
                  Text(this.post.is_favorited === 1 ? 'â™¥' : 'â™¡')
                    .fontSize(24)
                    .fontColor(this.post.is_favorited === 1 ? '#FF0000' : '#666666')
                  Text(this.post.likes.toString())
                    .fontSize(14)
                    .margin({ left: 5 })
                }
                .onClick(() => {
                  this.toggleLike();
                })
                .margin({ right: 24 })

                Row() {
                  Text('ðŸ’¬')
                    .fontSize(24)
                  Text(this.comments.length.toString())
                    .fontSize(14)
                    .margin({ left: 5 })
                }
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
            .margin({ bottom: 12 })

            // è¯„è®ºåŒºåŸŸ
            Column() {
              // è¯„è®ºæ ‡é¢˜
              Row() {
                Text('è¯„è®º')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .margin({ bottom: 12 })
              }
              .width('100%')

              // è¯„è®ºåˆ—è¡¨
              if (this.isLoadingComments) {
                Row() {
                  LoadingProgress()
                    .width(24)
                    .height(24)
                    .color('#1698CE')
                  Text('åŠ è½½è¯„è®ºä¸­...')
                    .fontSize(14)
                    .margin({ left: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({ vertical: 16 })
              } else if (this.comments.length === 0) {
                Text('æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§')
                  .fontSize(14)
                  .fontColor('#999999')
                  .width('100%')
                  .textAlign(TextAlign.Center)
                  .padding({ vertical: 16 })
              } else {
                Column() {
                  ForEach(this.comments, (comment: Comment) => {
                    Column() {
                      // è¯„è®ºç”¨æˆ·ä¿¡æ¯
                      Row() {
                        Image(comment.img_url || $r('app.media.icon'))
                          .width(32)
                          .height(32)
                          .borderRadius(16)
                          .margin({ right: 8 })
                        
                        Column() {
                          Text(comment.nickname)
                            .fontSize(14)
                            .fontWeight(FontWeight.Bold)
                          
                          Text(comment.create_time)
                            .fontSize(12)
                            .fontColor('#999999')
                        }
                        .alignItems(HorizontalAlign.Start)
                      }
                      .width('100%')
                      .margin({ bottom: 8 })
                      
                      // è¯„è®ºå†…å®¹
                      Text(comment.content)
                        .fontSize(15)
                        .width('100%')
                        .padding({ left: 40 })
                      
                      Divider()
                        .width('100%')
                        .margin({ top: 12, bottom: 12 })
                        .color('#EEEEEE')
                    }
                    .width('100%')
                  })
                }
                .width('100%')
              }
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#FFFFFF')
            .borderRadius(8)
          }
          .width('100%')
          .padding(12)
        }
        .width('100%')
        .layoutWeight(1)
      } else {
        Column() {
          Image($r('app.media.no_result'))
            .width(100)
            .height(100)
            .margin({ bottom: 20 })
          
          Text('å¸–å­ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤')
            .fontSize(16)
            .fontColor('#999999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }

      // è¯„è®ºè¾“å…¥åŒºåŸŸ
      Row() {
        TextInput({ placeholder: 'è¯´ç‚¹ä»€ä¹ˆ...', text: this.commentContent })
          .width('75%')
          .height(40)
          .backgroundColor('#F5F5F5')
          .borderRadius(20)
          .padding({ left: 12, right: 12 })
          .onChange((value: string) => {
            this.commentContent = value;
          })

        Button({ type: ButtonType.Normal, stateEffect: true }) {
          Row() {
            if (this.isSubmittingComment) {
              LoadingProgress()
                .width(20)
                .height(20)
                .color('#FFFFFF')
                .margin({ right: 5 })
            }
            Text('å‘é€')
              .fontColor('#FFFFFF')
          }
        }
        .width('20%')
        .height(40)
        .backgroundColor('#1698CE')
        .borderRadius(20)
        .enabled(!this.isSubmittingComment)
        .onClick(() => {
          this.submitComment();
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(16)
      .backgroundColor('#FFFFFF')
      .border({ width: { top: 0.5 }, color: '#EEEEEE' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
} 