"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AGCAuthRsaVerifier=void 0;var key_header_util_1=require("../utils/key-header-util"),crypto_1=require("crypto"),agc_auth_error_1=require("../error/agc-auth-error"),agc_auth_error_message_1=require("../error/agc-auth-error-message"),AGCAuthRsaVerifier=function(){function h(){}return h.verify=function(r,e,t,a){var _=!1;try{var o=key_header_util_1.KeyHeaderUtil.decodePublicKey(r),u=e.split(".")[2],i=e.split(".",2).join("."),s=h.toBase64(u),c=(0,crypto_1.createVerify)("RSA-SHA256");c.update(i),c.end(),_="PS256"===t?(n={key:o,padding:crypto_1.constants.RSA_PKCS1_PSS_PADDING,saltLength:crypto_1.constants.RSA_PSS_SALTLEN_DIGEST},c.verify(n,s,"base64")):c.verify(o,s,"base64")}catch(r){throw new agc_auth_error_1.AGCAuthError(agc_auth_error_message_1.AuthErrorCode.ACCESS_TOKEN_VERIFY_FAILED,a.getName(),r)}if(_){r=e.split(".",1)[0],u=JSON.parse(Buffer.from(r,"base64").toString("binary"));if(!u)throw new agc_auth_error_1.AGCAuthError(agc_auth_error_message_1.AuthErrorCode.ACCESS_TOKEN_VERIFY_FAILED,a.getName(),{message:"header decode failed"});var n,i=e.split(".")[1],t=Buffer.from(i,"base64").toString("utf8");return"JWT"===u.typ?((n=JSON.parse(t)).sub=h.getSub(t),n):t}throw new agc_auth_error_1.AGCAuthError(agc_auth_error_message_1.AuthErrorCode.ACCESS_TOKEN_VERIFY_FAILED,a.getName())},h.getSub=function(r){if(r)for(var e=r.split(","),t=0;t<e.length;t++)if(e[t].includes('"sub":'))return e[t].replace('"sub":',"")},h.toBase64=function(r){var e=r,t=4-e.length%4;if(4!=t)for(var a=0;a<t;++a)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")},h}();exports.AGCAuthRsaVerifier=AGCAuthRsaVerifier;